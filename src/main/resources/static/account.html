<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopverse - My Account</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Link to external stylesheet -->
    <link rel="stylesheet" href="styles.css">
</head>
<body class="min-h-screen bg-gray-100 antialiased">

<!-- Header from user's original code, styled with Tailwind -->
<header class="bg-gray-900 text-white py-4 shadow-lg">
    <div class="container mx-auto flex flex-col md:flex-row justify-between items-center px-4">
        <h1 class="text-3xl font-bold text-yellow-400 mb-2 md:mb-0">Shopverse</h1>
        <nav class="space-x-4">
            <a href="index.html" class="hover:text-yellow-400 transition duration-200">Home</a>
            <a href="products.html" class="hover:text-yellow-400 transition duration-200">Products</a>
            <a href="cart.html" class="hover:text-yellow-400 transition duration-200">Cart</a>
            <a href="account.html" class="hover:text-yellow-400 transition duration-200">Account</a>
        </nav>
    </div>
</header>

<div class="container mx-auto p-4 md:p-8">
    <div class="flex flex-col lg:flex-row bg-white rounded-xl shadow-2xl overflow-hidden">
        <!-- Sidebar Navigation -->
        <div class="w-full lg:w-1/4 bg-gray-800 text-white p-6 rounded-t-xl lg:rounded-l-xl lg:rounded-tr-none flex flex-col">
            <div class="text-2xl font-bold mb-8 text-center lg:text-left">My Account</div>
            <nav class="flex flex-col space-y-3" id="sidebar-nav">
                <button id="tab-dashboard" class="tab-button py-3 px-4 rounded-lg text-left transition duration-200 hover:bg-gray-700 active">
                    Dashboard
                </button>
                <button id="tab-orders" class="tab-button py-3 px-4 rounded-lg text-left transition duration-200 hover:bg-gray-700">
                    Order History
                </button>
                <button id="tab-profile" class="tab-button py-3 px-4 rounded-lg text-left transition duration-200 hover:bg-gray-700">
                    Personal Information
                </button>
                <button id="tab-addresses" class="tab-button py-3 px-4 rounded-lg text-left transition duration-200 hover:bg-gray-700">
                    Addresses
                </button>
                <button id="tab-payment" class="tab-button py-3 px-4 rounded-lg text-left transition duration-200 hover:bg-gray-700">
                    Payment Methods
                </button>
                <button id="tab-wishlist" class="tab-button py-3 px-4 rounded-lg text-left transition duration-200 hover:bg-gray-700">
                    Wishlist
                </button>
            </nav>
            <div class="mt-auto pt-8 text-center text-gray-400 text-sm">
                <button onclick="logout()" class="mt-8 px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-200 shadow-md">
                    Logout
                </button>
                <p class="mt-4">&copy; 2025 Shopverse</p>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="w-full lg:w-3/4 p-6 md:p-8 bg-gray-50 overflow-y-auto max-h-[calc(100vh-64px)] lg:max-h-full" id="main-content-area">
            <!-- Content will be loaded here by JavaScript -->
            <div id="loading-indicator" class="flex items-center justify-center min-h-[300px] text-indigo-600 text-lg font-semibold">
                Loading account details...
            </div>
            <div id="error-message" class="hidden flex items-center justify-center min-h-[300px] bg-red-100 text-red-800 p-4 rounded-md">
                <!-- Error messages will appear here -->
            </div>
        </div>
    </div>
</div>

<!-- Footer from user's original code, styled with Tailwind -->
<footer class="bg-gray-900 text-white py-4 text-center mt-8 shadow-inner">
    <p>&copy; 2025 Shopverse. All rights reserved.</p>
</footer>

<script type="module">
        // Dummy Data (for sections not yet integrated with user's backend)
        // These will be replaced by actual fetches if you extend your backend
        let userAddresses = [
            { id: 'ADDR001', name: 'Home', street: '123 Main St', city: 'Anytown', state: 'CA', zip: '90210', country: 'USA', isDefault: true },
            { id: 'ADDR002', name: 'Work', street: '456 Oak Ave', city: 'Otherville', state: 'NY', zip: '10001', country: 'USA', isDefault: false },
        ];
        let userPaymentMethods = [
            { id: 'PM001', type: 'Visa', last4: '1234', expiry: '12/27', isDefault: true },
            { id: 'PM002', type: 'Mastercard', last4: '5678', expiry: '08/26', isDefault: false },
        ];
        let userWishlist = [
            { id: 'WL001', name: 'Gaming Mouse', price: 75.00, imageUrl: 'https://placehold.co/100x100/A855F7/ffffff?text=Mouse' },
            { id: 'WL002', name: 'Mechanical Keyboard', price: 150.00, imageUrl: 'https://placehold.co/100x100/EC4899/ffffff?text=Keyboard' },
        ];

        // Global variables for user data
        let currentUserId = null;
        let userProfile = {
            username: 'Loading...',
            email: 'loading@example.com',
            fullName: 'Loading Name', // Added for dashboard welcome
            phone: 'N/A' // Added for profile section
        };
        let userOrders = [];

        // DOM elements
        const mainContentArea = document.getElementById('main-content-area');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const tabButtons = document.querySelectorAll('.tab-button');

        // Helper function to generate a random UUID (for dummy data/client-side additions)
        const generateUUID = () => crypto.randomUUID();

        // --- User Authentication and Data Fetching (from your backend) ---
        async function loadUserDataAndOrders() {
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');

            const email = localStorage.getItem('userEmail');
            const userId = localStorage.getItem('userId');

            if (!email || !userId) {
                // Using a custom message box instead of alert()
                displayMessageBox("Please log in to view your account.");
                setTimeout(() => { window.location.href = "/login.html"; }, 1500);
                return;
            }

            currentUserId = userId; // Set currentUserId from localStorage

            try {
                // Fetch user profile info
                const userRes = await fetch(`http://localhost:8087/api/users/by-email?email=${encodeURIComponent(email)}`);
                if (!userRes.ok) throw new Error("User not found");
                const user = await userRes.json();
                userProfile.username = user.username;
                userProfile.email = user.email;
                userProfile.fullName = user.username; // Assuming username is full name for display

                // Load order history
                const ordersRes = await fetch(`http://localhost:8087/api/orders/user/${userId}`);
                if (!ordersRes.ok) throw new Error("Could not fetch orders");
                userOrders = await ordersRes.json();

                loadingIndicator.classList.add('hidden');
                renderContent('dashboard'); // Render initial dashboard after data loads
            } catch (err) {
                console.error("Failed to load user or order details:", err);
                loadingIndicator.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                errorMessage.innerHTML = `<p>Failed to load account details: ${err.message}. Please try again.</p>`;
            }
        }

        // --- Message Box Function (replaces alert()) ---
        function displayMessageBox(message, onConfirm = null, showCancel = false) {
            const messageBox = document.createElement('div');
            messageBox.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50';
            messageBox.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto">
                    <p class="text-lg font-semibold text-gray-800 mb-4">${message}</p>
                    <div class="flex justify-center space-x-4">
                        <button id="msg-box-ok" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-200">OK</button>
                        ${showCancel ? `<button id="msg-box-cancel" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-200">Cancel</button>` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(messageBox);

            document.getElementById('msg-box-ok').onclick = () => {
                messageBox.remove();
                if (onConfirm) {
                    onConfirm();
                }
            };

            if (showCancel) {
                document.getElementById('msg-box-cancel').onclick = () => {
                    messageBox.remove();
                };
            }
        }

        // --- Logout Function ---
        function logout() {
            localStorage.clear();
            window.location.href = "/login.html";
        }
        // Make logout globally accessible for the button in HTML
        window.logout = logout;


        // --- Render Functions for Each Section ---

        function renderDashboard() {
            const recentOrders = userOrders.slice(0, 3);
            mainContentArea.innerHTML = `
                <div class="p-6 bg-white rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Welcome, ${userProfile.fullName || userProfile.username || 'User'}!</h2>
                    <p class="text-sm text-gray-600 mb-4">Your User ID: <span class="font-mono bg-gray-100 px-2 py-1 rounded">${currentUserId || 'N/A'}</span></p>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold mb-2">Recent Orders</h3>
                            <p class="text-4xl font-bold">${userOrders.length}</p>
                            <p class="text-sm">total orders</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-teal-600 text-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold mb-2">Wishlist Items</h3>
                            <p class="text-4xl font-bold">${userWishlist.length}</p>
                            <p class="text-sm">items saved</p>
                        </div>
                        <div class="bg-gradient-to-br from-orange-500 to-red-600 text-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold mb-2">Saved Addresses</h3>
                            <p class="text-4xl font-bold">${userAddresses.length}</p>
                            <p class="text-sm">addresses on file</p>
                        </div>
                    </div>

                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Your Latest Order</h3>
                    ${recentOrders.length > 0 ? `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <p class="text-lg font-medium">Order ID: <span class="font-normal">${recentOrders[0].id}</span></p>
                            <p class="text-md text-gray-700">Total: $${recentOrders[0].totalPrice.toFixed(2)}</p>
                            <p class="text-md text-gray-700">Created Date: ${recentOrders[0].createdDate}</p>
                            <button class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-200 shadow-md">
                                View Order Details
                            </button>
                        </div>
                    ` : `
                        <p class="text-gray-600">No recent orders to display.</p>
                    `}
                </div>
            `;
        }

        function renderOrderHistory() {
            mainContentArea.innerHTML = `
                <div class="p-6 bg-white rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Order History</h2>
                    ${userOrders.length === 0 ? `
                        <p class="text-gray-600">You haven't placed any orders yet.</p>
                    ` : `
                        <div class="overflow-x-auto">
                            <div class="space-y-4">
                                ${userOrders.map(order => `
                                    <div class="order-card">
                                        <h4 class="text-xl font-semibold text-gray-800 mb-2">Order ID: ${order.id}</h4>
                                        <p class="text-gray-700">Total Price: <span class="font-medium text-indigo-600">$${order.totalPrice.toFixed(2)}</span></p>
                                        <p class="text-gray-700">Created Date: ${order.createdDate}</p>
                                        <h5 class="text-lg font-medium text-gray-800 mt-4 mb-2">Items:</h5>
                                        <ul>
                                            ${order.orderItems.map(item => `
                                                <li>
                                                    <img src="${item.imageUrl}" alt="${item.productName}" class="w-12 h-12 object-cover rounded-md border border-gray-300" onerror="this.onerror=null;this.src='https://placehold.co/50x50/CCCCCC/000000?text=No+Image';" />
                                                    <span class="text-gray-700">${item.productName}</span> - Quantity: <span class="font-medium">${item.quantity}</span> - Price: <span class="font-medium">$${item.price.toFixed(2)}</span>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function renderPersonalInformation(editMode = false) {
            mainContentArea.innerHTML = `
                <div class="p-6 bg-white rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Personal Information</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Username</label>
                            ${editMode ? `
                                <input type="text" id="profile-username" value="${userProfile.username}"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
                            ` : `
                                <p class="mt-1 text-gray-900">${userProfile.username}</p>
                            `}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email Address</label>
                            ${editMode ? `
                                <input type="email" id="profile-email" value="${userProfile.email}"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
                            ` : `
                                <p class="mt-1 text-gray-900">${userProfile.email}</p>
                            `}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Full Name</label>
                            ${editMode ? `
                                <input type="text" id="profile-fullName" value="${userProfile.fullName}"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
                            ` : `
                                <p class="mt-1 text-gray-900">${userProfile.fullName}</p>
                            `}
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                            ${editMode ? `
                                <input type="tel" id="profile-phone" value="${userProfile.phone}"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
                            ` : `
                                <p class="mt-1 text-gray-900">${userProfile.phone}</p>
                            `}
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-4">
                        ${editMode ? `
                            <button id="save-profile-btn" class="px-5 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-200 shadow-md">
                                Save Changes
                            </button>
                            <button id="cancel-profile-btn" class="px-5 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-200 shadow-sm">
                                Cancel
                            </button>
                        ` : `
                            <button id="edit-profile-btn" class="px-5 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200 shadow-md">
                                Edit Profile
                            </button>
                        `}
                    </div>
                </div>
            `;

            if (editMode) {
                document.getElementById('save-profile-btn').onclick = () => {
                    userProfile.username = document.getElementById('profile-username').value;
                    userProfile.email = document.getElementById('profile-email').value;
                    userProfile.fullName = document.getElementById('profile-fullName').value;
                    userProfile.phone = document.getElementById('profile-phone').value;
                    // In a real application, you would send these updates to your backend API.
                    // For now, we just update the local state.
                    displayMessageBox("Profile updated locally! (Backend integration needed for persistence)");
                    renderPersonalInformation(false);
                };
                document.getElementById('cancel-profile-btn').onclick = () => renderPersonalInformation(false);
            } else {
                document.getElementById('edit-profile-btn').onclick = () => renderPersonalInformation(true);
            }
        }

        function renderAddresses(showAddForm = false, addressToEdit = null) {
            mainContentArea.innerHTML = `
                <div class="p-6 bg-white rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Your Addresses</h2>
                    <button id="add-address-btn" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200 shadow-md mb-6">
                        Add New Address
                    </button>

                    <div id="address-form-container"></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="addresses-list">
                        ${userAddresses.length === 0 ? `
                            <p class="text-gray-600">No addresses saved yet.</p>
                        ` : userAddresses.map(address => `
                            <div class="border border-gray-200 p-4 rounded-lg shadow-sm bg-gray-50">
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">${address.name} ${address.isDefault ? `<span class="ml-2 text-xs bg-indigo-200 text-indigo-800 px-2 py-1 rounded-full">Default</span>` : ''}</h3>
                                <p class="text-gray-700">${address.street}</p>
                                <p class="text-gray-700">${address.city}, ${address.state} ${address.zip}</p>
                                <p class="text-gray-700">${address.country}</p>
                                <div class="mt-4 flex space-x-3">
                                    <button data-id="${address.id}" class="edit-address-btn text-blue-600 hover:text-blue-800 font-medium text-sm">
                                        Edit
                                    </button>
                                    <button data-id="${address.id}" class="delete-address-btn text-red-600 hover:text-red-800 font-medium text-sm">
                                        Delete
                                    </button>
                                    ${!address.isDefault ? `
                                        <button data-id="${address.id}" class="set-default-address-btn text-indigo-600 hover:text-indigo-800 font-medium text-sm">
                                            Set as Default
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            document.getElementById('add-address-btn').onclick = () => renderAddresses(true);

            if (showAddForm) {
                renderAddressForm(addressToEdit);
            }

            document.querySelectorAll('.edit-address-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.id;
                    const address = userAddresses.find(a => a.id === id);
                    renderAddresses(true, address);
                };
            });

            document.querySelectorAll('.delete-address-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.id;
                    // Replaced confirm() with displayMessageBox for consistency
                    displayMessageBox("Are you sure you want to delete this address?", () => {
                        userAddresses = userAddresses.filter(a => a.id !== id);
                        displayMessageBox("Address deleted locally! (Backend integration needed for persistence)");
                        renderAddresses(false);
                    }, true); // Pass true to indicate it's a confirmation
                };
            });

            document.querySelectorAll('.set-default-address-btn').forEach(button => {
                button.onclick = (e) => {
                    const idToSetDefault = e.target.dataset.id;
                    userAddresses = userAddresses.map(a => ({ ...a, isDefault: a.id === idToSetDefault }));
                    displayMessageBox("Default address updated locally! (Backend integration needed for persistence)");
                    renderAddresses(false);
                };
            });
        }

        function renderAddressForm(address = null) {
            const formContainer = document.getElementById('address-form-container');
            const isEdit = address !== null;
            formContainer.innerHTML = `
                <div class="bg-gray-100 p-6 rounded-lg shadow-inner mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">${isEdit ? 'Edit Address' : 'Add New Address'}</h3>
                    <form id="address-form" class="space-y-4">
                        <div>
                            <label for="address-name" class="block text-sm font-medium text-gray-700">Address Name (e.g., Home, Work)</label>
                            <input type="text" id="address-name" name="name" value="${address?.name || ''}" required
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
                        </div>
                        <div>
                            <label for="address-street" class="block text-sm font-medium text-gray-700">Street Address</label>
                            <input type="text" id="address-street" name="street" value="${address?.street || ''}" required
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="address-city" class="block text-sm font-medium text-gray-700">City</label>
                                <input type="text" id="address-city" name="city" value="${address?.city || ''}" required
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
                            </div>
                            <div>
                                <label for="address-state" class="block text-sm font-medium text-gray-700">State</label>
                                <input type="text" id="address-state" name="state" value="${address?.state || ''}" required
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
                            </div>
                            <div>
                                <label for="address-zip" class="block text-sm font-medium text-gray-700">Zip Code</label>
                                <input type="text" id="address-zip" name="zip" value="${address?.zip || ''}" required
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
                            </div>
                        </div>
                        <div>
                            <label for="address-country" class="block text-sm font-medium text-gray-700">Country</label>
                            <input type="text" id="address-country" name="country" value="${address?.country || ''}" required
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="address-isDefault" name="isDefault" ${address?.isDefault ? 'checked' : ''}
                                class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" />
                            <label for="address-isDefault" class="ml-2 block text-sm text-gray-900">Set as default address</label>
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-200 shadow-md">
                                ${isEdit ? 'Update Address' : 'Add Address'}
                            </button>
                            <button type="button" id="cancel-address-form-btn" class="px-5 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-200 shadow-sm">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.getElementById('address-form').onsubmit = (e) => {
                e.preventDefault();
                const newAddress = {
                    name: document.getElementById('address-name').value,
                    street: document.getElementById('address-street').value,
                    city: document.getElementById('address-city').value,
                    state: document.getElementById('address-state').value,
                    zip: document.getElementById('address-zip').value,
                    country: document.getElementById('address-country').value,
                    isDefault: document.getElementById('address-isDefault').checked,
                };

                if (isEdit) {
                    userAddresses = userAddresses.map(a => a.id === address.id ? { ...newAddress, id: address.id } : a);
                    displayMessageBox("Address updated locally! (Backend integration needed for persistence)");
                } else {
                    userAddresses.push({ ...newAddress, id: generateUUID() });
                    displayMessageBox("Address added locally! (Backend integration needed for persistence)");
                }
                renderAddresses(false); // Re-render addresses list
            };
            document.getElementById('cancel-address-form-btn').onclick = () => renderAddresses(false);
        }

        function renderPaymentMethods(showAddForm = false, methodToEdit = null) {
            mainContentArea.innerHTML = `
                <div class="p-6 bg-white rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Payment Methods</h2>
                    <button id="add-payment-btn" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200 shadow-md mb-6">
                        Add New Card
                    </button>

                    <div id="payment-form-container"></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="payment-methods-list">
                        ${userPaymentMethods.length === 0 ? `
                            <p class="text-gray-600">No payment methods saved yet.</p>
                        ` : userPaymentMethods.map(method => `
                            <div class="border border-gray-200 p-4 rounded-lg shadow-sm bg-gray-50 flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800 mb-1">
                                        ${method.type} ending in ${method.last4} ${method.isDefault ? `<span class="ml-2 text-xs bg-indigo-200 text-indigo-800 px-2 py-1 rounded-full">Default</span>` : ''}
                                    </h3>
                                    <p class="text-gray-700">Expires: ${method.expiry}</p>
                                </div>
                                <div class="flex space-x-3">
                                    <button data-id="${method.id}" class="edit-payment-btn text-blue-600 hover:text-blue-800 font-medium text-sm">
                                        Edit
                                    </button>
                                    <button data-id="${method.id}" class="delete-payment-btn text-red-600 hover:text-red-800 font-medium text-sm">
                                        Delete
                                    </button>
                                    ${!method.isDefault ? `
                                        <button data-id="${method.id}" class="set-default-payment-btn text-indigo-600 hover:text-indigo-800 font-medium text-sm">
                                            Set as Default
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <p class="mt-6 text-sm text-gray-600">
                        Your payment information is securely stored and encrypted.
                    </p>
                </div>
            `;

            document.getElementById('add-payment-btn').onclick = () => renderPaymentMethods(true);

            if (showAddForm) {
                renderPaymentMethodForm(methodToEdit);
            }

            document.querySelectorAll('.edit-payment-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.id;
                    const method = userPaymentMethods.find(m => m.id === id);
                    renderPaymentMethods(true, method);
                };
            });

            document.querySelectorAll('.delete-payment-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.id;
                    // Replaced confirm() with displayMessageBox for consistency
                    displayMessageBox("Are you sure you want to delete this payment method?", () => {
                        userPaymentMethods = userPaymentMethods.filter(pm => pm.id !== id);
                        displayMessageBox("Payment method deleted locally! (Backend integration needed for persistence)");
                        renderPaymentMethods(false);
                    }, true); // Pass true to indicate it's a confirmation
                };
            });

            document.querySelectorAll('.set-default-payment-btn').forEach(button => {
                button.onclick = (e) => {
                    const idToSetDefault = e.target.dataset.id;
                    userPaymentMethods = userPaymentMethods.map(pm => ({ ...pm, isDefault: pm.id === idToSetDefault }));
                    displayMessageBox("Default payment method updated locally! (Backend integration needed for persistence)");
                    renderPaymentMethods(false);
                };
            });
        }

        function renderPaymentMethodForm(method = null) {
            const formContainer = document.getElementById('payment-form-container');
            const isEdit = method !== null;
            formContainer.innerHTML = `
                <div class="bg-gray-100 p-6 rounded-lg shadow-inner mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">${isEdit ? 'Edit Payment Method' : 'Add New Payment Method'}</h3>
                    <form id="payment-method-form" class="space-y-4">
                        <div>
                            <label for="payment-type" class="block text-sm font-medium text-gray-700">Card Type</label>
                            <select id="payment-type" name="type" required
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="Visa" ${method?.type === 'Visa' ? 'selected' : ''}>Visa</option>
                                <option value="Mastercard" ${method?.type === 'Mastercard' ? 'selected' : ''}>Mastercard</option>
                                <option value="Amex" ${method?.type === 'Amex' ? 'selected' : ''}>American Express</option>
                                <option value="Discover" ${method?.type === 'Discover' ? 'selected' : ''}>Discover</option>
                            </select>
                        </div>
                        <div>
                            <label for="payment-last4" class="block text-sm font-medium text-gray-700">Last 4 Digits</label>
                            <input type="text" id="payment-last4" name="last4" value="${method?.last4 || ''}" maxLength="4" required
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
                        </div>
                        <div>
                            <label for="payment-expiry" class="block text-sm font-medium text-gray-700">Expiry Date (MM/YY)</label>
                            <input type="text" id="payment-expiry" name="expiry" value="${method?.expiry || ''}" placeholder="MM/YY" maxLength="5" required
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="payment-isDefault" name="isDefault" ${method?.isDefault ? 'checked' : ''}
                                class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" />
                            <label for="payment-isDefault" class="ml-2 block text-sm text-gray-900">Set as default payment method</label>
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-200 shadow-md">
                                ${isEdit ? 'Update Card' : 'Add Card'}
                            </button>
                            <button type="button" id="cancel-payment-form-btn" class="px-5 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-200 shadow-sm">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.getElementById('payment-method-form').onsubmit = (e) => {
                e.preventDefault();
                const newMethod = {
                    type: document.getElementById('payment-type').value,
                    last4: document.getElementById('payment-last4').value,
                    expiry: document.getElementById('payment-expiry').value,
                    isDefault: document.getElementById('payment-isDefault').checked,
                };

                if (isEdit) {
                    userPaymentMethods = userPaymentMethods.map(pm => pm.id === method.id ? { ...newMethod, id: method.id } : pm);
                    displayMessageBox("Payment method updated locally! (Backend integration needed for persistence)");
                } else {
                    userPaymentMethods.push({ ...newMethod, id: generateUUID() });
                    displayMessageBox("Payment method added locally! (Backend integration needed for persistence)");
                }
                renderPaymentMethods(false); // Re-render payment methods list
            };
            document.getElementById('cancel-payment-form-btn').onclick = () => renderPaymentMethods(false);
        }

        function renderWishlist() {
            mainContentArea.innerHTML = `
                <div class="p-6 bg-white rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Your Wishlist</h2>
                    ${userWishlist.length === 0 ? `
                        <p class="text-gray-600">Your wishlist is empty. Start adding some items!</p>
                    ` : `
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${userWishlist.map(item => `
                                <div class="border border-gray-200 p-4 rounded-lg shadow-sm bg-gray-50 flex flex-col items-center text-center">
                                    <img src="${item.imageUrl}" alt="${item.name}" class="w-24 h-24 object-cover rounded-md mb-3" onerror="this.onerror=null;this.src='https://placehold.co/100x100/CCCCCC/000000?text=No+Image';" />
                                    <h3 class="text-lg font-semibold text-gray-800 mb-1">${item.name}</h3>
                                    <p class="text-xl font-bold text-indigo-600 mb-3">$${item.price.toFixed(2)}</p>
                                    <div class="flex space-x-2">
                                        <button class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-200 shadow-md text-sm">
                                            Add to Cart
                                        </button>
                                        <button data-id="${item.id}" class="remove-wishlist-btn px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-200 shadow-sm text-sm">
                                            Remove
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;

            document.querySelectorAll('.remove-wishlist-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.id;
                    // Replaced confirm() with displayMessageBox for consistency
                    displayMessageBox("Are you sure you want to remove this item from your wishlist?", () => {
                        userWishlist = userWishlist.filter(item => item.id !== id);
                        displayMessageBox("Item removed locally! (Backend integration needed for persistence)");
                        renderWishlist();
                    }, true); // Pass true to indicate it's a confirmation
                };
            });
        }

        // --- Main Content Renderer ---
        const renderFunctions = {
            dashboard: renderDashboard,
            orders: renderOrderHistory,
            profile: renderPersonalInformation,
            addresses: renderAddresses,
            payment: renderPaymentMethods,
            wishlist: renderWishlist,
        };

        function renderContent(tabName) {
            errorMessage.classList.add('hidden'); // Hide any previous errors
            mainContentArea.innerHTML = ''; // Clear previous content
            if (renderFunctions[tabName]) {
                renderFunctions[tabName]();
            } else {
                mainContentArea.innerHTML = `<p class="text-red-600">Content for ${tabName} not found.</p>`;
            }
        }

        // --- Event Listeners for Sidebar Navigation ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove 'active' class from all buttons
                tabButtons.forEach(btn => btn.classList.remove('active'));
                // Add 'active' class to the clicked button
                button.classList.add('active');
                // Get the tab name from the button's ID
                const tabName = button.id.replace('tab-', '');
                renderContent(tabName);
            });
        });

        // Initial load of user data and render dashboard
        document.addEventListener('DOMContentLoaded', loadUserDataAndOrders);
    </script>
</body>
</html>
